<!-- Agrega este script adicional para cargar la API de Google -->
<script src="https://apis.google.com/js/api.js"></script>

<script>
  // Configuración de la API de Google Identity Services (GIS)
  const CLIENT_ID = 'YOUR_CLIENT_ID';
  const API_KEY = 'YOUR_API_KEY';
  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
  const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

  let tokenClient;
  let gapiInited = false;
  let gisInited = false;

  // Cargar la biblioteca de Google API
  function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
  }

  async function initializeGapiClient() {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: [DISCOVERY_DOC],
    });
    gapiInited = true;
    maybeEnableButtons();
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '', // definido más adelante
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('search-button').disabled = false;
    }
  }

  // Función para manejar el clic del botón de búsqueda
  document.getElementById('search-button').addEventListener('click', function() {
    if (gapi.client.getToken() === null) {
      // Solicitar token de acceso
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        await fetchDataFromSheet();
      };
      tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
      fetchDataFromSheet();
    }
  });

  // Función para buscar datos en Google Sheets
  async function fetchDataFromSheet() {
    const qrData = document.getElementById('qr-result').value;
    if (!qrData) {
      alert('Primero debes escanear un código QR.');
      return;
    }

    try {
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: 'YOUR_SPREADSHEET_ID',
        range: 'Sheet1!A:G',
      });
      const rows = response.result.values;

      if (!rows || rows.length === 0) {
        alert('No se encontraron datos en la hoja de cálculo.');
        return;
      }

      const result = rows.find(row => row[0] === qrData);

      if (result) {
        alert(`Datos encontrados:\nID: ${result[0]}\nNombre: ${result[1]}`);
      } else {
        alert('No se encontraron datos para el código QR escaneado.');
      }
    } catch (err) {
      console.error('Error al obtener datos de Google Sheets:', err);
    }
  }

  // Inicializar todo cuando se carga la página
  window.onload = function() {
    // Cargar las bibliotecas de Google API y GIS
    gapiLoaded();
    gisLoaded();
    startCamera();
    document.getElementById('search-button').disabled = true; // Desactivar hasta que GIS esté listo
  };
</script>
